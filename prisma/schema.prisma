generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  username      String   @unique
  password      String
  firstName     String?
  lastName      String?
  bio           String?
  avatar        String?
  coverPhoto    String?
  website       String?
  location      String?
  isVerified    Boolean  @default(false)
  isPrivate     Boolean  @default(false)
  refreshToken  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  followers     Follow[]  @relation("UserFollowers")
  following     Follow[]  @relation("UserFollowing")
  stories       Story[]
  notifications Notification[] @relation("NotificationRecipient")
  sentNotifications Notification[] @relation("NotificationSender")
  savedPosts    SavedPost[]
  sentMessages  Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  @@map("users")
}

// Follow system
model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("follows")
}

// Posts
model Post {
  id          String    @id @default(uuid())
  userId      String
  content     String?
  mediaUrls   String[]
  mediaType   MediaType @default(IMAGE)
  location    String?
  isPublic    Boolean   @default(true)
  commentsEnabled Boolean @default(true)
  likesCount  Int       @default(0)
  commentsCount Int     @default(0)
  sharesCount Int       @default(0)
  viewsCount  Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments   Comment[]
  likes      Like[]
  hashtags   PostHashtag[]
  mentions   PostMention[]
  savedBy    SavedPost[]

  @@index([userId])
  @@index([createdAt])
  @@map("posts")
}

enum MediaType {
  IMAGE
  VIDEO
  MIXED
}

// Comments
model Comment {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  content   String
  parentId  String?
  likesCount Int     @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post     Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")
  likes    CommentLike[]

  @@index([postId])
  @@index([userId])
  @@map("comments")
}

// Likes
model Like {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("likes")
}

// Comment Likes
model CommentLike {
  id        String   @id @default(uuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())

  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@map("comment_likes")
}

// Hashtags
model Hashtag {
  id        String   @id @default(uuid())
  name      String   @unique
  count     Int      @default(0)
  createdAt DateTime @default(now())

  posts PostHashtag[]

  @@map("hashtags")
}

// Post Hashtags (Many-to-Many)
model PostHashtag {
  id        String   @id @default(uuid())
  postId    String
  hashtagId String
  createdAt DateTime @default(now())

  post    Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  hashtag Hashtag @relation(fields: [hashtagId], references: [id], onDelete: Cascade)

  @@unique([postId, hashtagId])
  @@map("post_hashtags")
}

// Mentions
model PostMention {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("post_mentions")
}

// Saved Posts
model SavedPost {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("saved_posts")
}

// Stories (24h expiry)
model Story {
  id        String    @id @default(uuid())
  userId    String
  mediaUrl  String
  mediaType MediaType @default(IMAGE)
  caption   String?
  viewsCount Int      @default(0)
  expiresAt DateTime
  createdAt DateTime  @default(now())

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  views StoryView[]

  @@index([userId])
  @@index([expiresAt])
  @@map("stories")
}

// Story Views
model StoryView {
  id        String   @id @default(uuid())
  storyId   String
  userId    String
  createdAt DateTime @default(now())

  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId])
  @@map("story_views")
}

// Direct Messages
model Message {
  id         String   @id @default(uuid())
  senderId   String
  receiverId String
  content    String
  mediaUrl   String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@map("messages")
}

// Notifications
model Notification {
  id         String           @id @default(uuid())
  userId     String
  senderId   String?
  type       NotificationType
  entityId   String?
  message    String
  isRead     Boolean          @default(false)
  createdAt  DateTime         @default(now())

  user   User  @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  sender User? @relation("NotificationSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  MENTION
  MESSAGE
}
